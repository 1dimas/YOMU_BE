generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Major {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  users     User[]

  @@map("majors")
}

model Class {
  id        String   @id @default(uuid())
  name      String   @unique
  createdAt DateTime @default(now()) @map("created_at")
  users     User[]

  @@map("classes")
}

model User {
  id               String         @id @default(uuid())
  email            String         @unique
  password         String
  name             String
  role             Role           @default(SISWA)
  avatarUrl        String?        @map("avatar_url")
  majorId          String?        @map("major_id")
  classId          String?        @map("class_id")
  isActive         Boolean        @default(true) @map("is_active")
  deletedAt        DateTime?      @map("deleted_at")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  conversations1   Conversation[] @relation("Participant1")
  conversations2   Conversation[] @relation("Participant2")
  favorites        Favorite[]
  loans            Loan[]         @relation("UserLoans")
  verifiedLoans    Loan[]         @relation("VerifiedLoans")
  receivedMessages Message[]      @relation("ReceivedMessages")
  sentMessages     Message[]      @relation("SentMessages")
  reviews          Review[]
  class            Class?         @relation(fields: [classId], references: [id])
  major            Major?         @relation(fields: [majorId], references: [id])

  @@map("users")
}

model Book {
  id             String     @id @default(uuid())
  title          String
  author         String
  publisher      String
  year           Int
  isbn           String     @unique
  categoryId     String     @map("category_id")
  synopsis       String
  coverUrl       String?    @map("cover_url")
  stock          Int        @default(0)
  availableStock Int        @default(0) @map("available_stock")
  deletedAt      DateTime?  @map("deleted_at")
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")
  category       Category   @relation(fields: [categoryId], references: [id])
  favorites      Favorite[]
  loans          Loan[]
  messages       Message[]
  reviews        Review[]

  @@index([title])
  @@index([categoryId])
  @@map("books")
}

model Category {
  id          String    @id @default(uuid())
  name        String    @unique
  color       String?   @default("#3b82f6")
  createdAt   DateTime  @default(now()) @map("created_at")
  description String?
  deletedAt   DateTime? @map("deleted_at")
  books       Book[]

  @@map("categories")
}

model Loan {
  id            String         @id @default(uuid())
  userId        String         @map("user_id")
  bookId        String         @map("book_id")
  loanDate      DateTime       @default(now()) @map("loan_date")
  dueDate       DateTime       @map("due_date")
  returnDate    DateTime?      @map("return_date")
  status        LoanStatus     @default(PENDING)
  bookCondition BookCondition? @map("book_condition")
  fineAmount    Int?           @map("fine_amount")
  adminNotes    String?        @map("admin_notes")
  verifiedBy    String?        @map("verified_by")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  book          Book           @relation(fields: [bookId], references: [id])
  user          User           @relation("UserLoans", fields: [userId], references: [id])
  verifier      User?          @relation("VerifiedLoans", fields: [verifiedBy], references: [id])

  @@index([userId])
  @@index([status])
  @@map("loans")
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  bookId    String   @map("book_id")
  createdAt DateTime @default(now()) @map("created_at")
  book      Book     @relation(fields: [bookId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, bookId])
  @@map("favorites")
}

model Message {
  id          String      @id @default(uuid())
  senderId    String      @map("sender_id")
  receiverId  String      @map("receiver_id")
  content     String
  isRead      Boolean     @default(false) @map("is_read")
  isEdited    Boolean     @default(false) @map("is_edited")
  messageType MessageType @default(TEXT) @map("message_type")
  bookId      String?     @map("book_id")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  book        Book?       @relation(fields: [bookId], references: [id])
  receiver    User        @relation("ReceivedMessages", fields: [receiverId], references: [id])
  sender      User        @relation("SentMessages", fields: [senderId], references: [id])

  @@index([senderId])
  @@index([receiverId])
  @@map("messages")
}

model Conversation {
  id             String   @id @default(uuid())
  participant1Id String   @map("participant_1")
  participant2Id String   @map("participant_2")
  lastMessageAt  DateTime @default(now()) @map("last_message_at")
  createdAt      DateTime @default(now()) @map("created_at")
  participant1   User     @relation("Participant1", fields: [participant1Id], references: [id])
  participant2   User     @relation("Participant2", fields: [participant2Id], references: [id])

  @@unique([participant1Id, participant2Id])
  @@map("conversations")
}

model Review {
  id        String   @id @default(uuid())
  rating    Int
  comment   String
  userId    String   @map("user_id")
  bookId    String   @map("book_id")
  createdAt DateTime @default(now()) @map("created_at")
  book      Book     @relation(fields: [bookId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, bookId])
  @@map("reviews")
}

enum Role {
  SISWA
  ADMIN
}

enum LoanStatus {
  PENDING
  APPROVED
  BORROWED
  RETURNING
  RETURNED
  REJECTED
  OVERDUE
}

enum BookCondition {
  GOOD
  DAMAGED
  LOST
}

enum MessageType {
  TEXT
  BOOK_CARD
}
